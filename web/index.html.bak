<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NATS Recorder Control Panel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .half-screen { margin-bottom: 30px; border: 1px solid #ccc; padding: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        button { padding: 10px 15px; margin-right: 10px; cursor: pointer; }
        .status-recording { background-color: #ffdddd; }
        .status-idle { background-color: #ddffdd; }
    </style>
</head>
<body>

<div class="container">
    <h1>NATS Recorder Control Panel</h1>

    <!-- 上半屏：控制与状态 -->
    <div class="half-screen" id="control-section">
        <h2>1. Agent Control & Status</h2>
        
        <!-- 控制按钮 -->
        <div>
            <button onclick="sendCommand('start_record')" style="background-color: green; color: white;">开始录音 (start_record)</button>
            <button onclick="sendCommand('stop_record')" style="background-color: red; color: white;">停止录音 (stop_record)</button>
        </div>
        <p id="command-feedback" style="margin-top: 10px; color: blue;"></p>

        <!-- 状态表格 -->
        <h3>Connected Agent Status</h3>
        <table>
            <thead>
                <tr>
                    <th>Session ID</th>
                    <th>Status</th>
                    <th>Last Updated</th>
                </tr>
            </thead>
            <tbody>
                {{range .AgentStatuses}}
                <tr class="status-{{.Status}}">
                    <td>{{.SessionID}}</td>
                    <td><strong>{{.Status}}</strong></td>
                    <td>{{.LastUpdate.Format "2006-01-02 15:04:05"}}</td>
                </tr>
                {{end}}
                {{if not .AgentStatuses}}
                <tr><td colspan="3">No agents currently reporting status.</td></tr>
                {{end}}
            </tbody>
        </table>
    </div>

    <!-- 下半屏：历史记录 -->
    <div class="half-screen" id="history-section">
        <h2>2. Recording History (Recent 10)</h2>
        <table>
            <thead>
                <tr>
                    <th>File Name</th>
                    <th>Upload Time</th>
                    <th>Size (KB)</th>
                    <th>Transcript</th>
                </tr>
            </thead>
            <tbody>
                {{range .RecordingHistory}}
                <tr>
                    <td>{{.FileName}}</td>
                    <td>{{.UploadTime.Format "2006-01-02 15:04:05"}}</td>
                    <td>{{.SizeKB}}</td>
                    <td>{{.Transcript}}</td>
                </tr>
                {{end}}
                {{if not .RecordingHistory}}
                <tr><td colspan="4">No recording history found.</td></tr>
                {{end}}
            </tbody>
        </table>
    </div>
</div>

<script>
    function sendCommand(action) {
        const feedback = document.getElementById('command-feedback');
        feedback.textContent = `Sending command: ${action}...`;

        fetch(`/api/command?action=${action}`)
            .then(response => response.text())
            .then(data => {
                feedback.textContent = `Command successful: ${data}`;
                // 成功后，建议刷新页面以获取最新的Agent状态和历史记录
                setTimeout(() => {
                    window.location.reload();
                }, 1000); 
            })
            .catch(error => {
                console.error('Error:', error);
                feedback.textContent = `Command failed: ${error.message}`;
            });
    }
    
    // Note: For a truly real-time application, the status table should be updated 
    // using WebSockets or Server-Sent Events (SSE) bridged from NATS, 
    // rather than requiring a page refresh after every command.
</script>

</body>
</html>
